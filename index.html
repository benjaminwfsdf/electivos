<!DOCTYPE html>
<html lang="es-CL">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#f58b1f">
<title>Carta de Postulación a Electividades 2025 · Liceo Teniente Dagoberto Godoy Nº3</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --brand:#0b5db6;--brand-strong:#0a4f9d;--orange:#f58b1f;
  --bg:#f4f7fb;--card:#fff;--ink:#1f2937;--muted:#555;
  --border:#e7eefb;--radius:18px;--shadow-sm:0 8px 18px rgba(10,79,157,.10);
}
body{margin:0;font-family:"Montserrat",sans-serif;color:var(--ink);
background:var(--bg);display:grid;grid-template-rows:auto 1fr auto;min-height:100dvh;overflow-x:hidden;}
.brandbar{background:linear-gradient(90deg,#f58b1f,#f3a24a 30%,#4783cf 75%,#0b5db6 100%);color:#fff;}
.brandbar-inner{max-width:980px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:12px;}
.logo-colegio{height:72px;width:auto;object-fit:contain;}
.wrap{max-width:980px;margin:20px auto;padding:0 16px;}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
padding:22px;box-shadow:var(--shadow-sm);}
h1{font-size:1.4rem;margin:0 0 14px;font-weight:700;color:var(--brand-strong);}
h2{margin-top:22px;color:var(--brand-strong)}
label{font-weight:600;}
input,select{width:100%;padding:10px;border:1px solid #dce6f7;border-radius:10px;margin:4px 0 12px;}
button{background:var(--orange);color:#fff;font-weight:700;border:none;border-radius:12px;
padding:12px 20px;cursor:pointer;display:block;margin:25px auto 0;box-shadow:0 6px 14px rgba(245,139,31,.25);}
button:hover{background:#e57e12;}
footer{text-align:center;font-size:.9rem;color:var(--muted);
padding:14px 10px;border-top:1px solid #e9eef9;background:#f6f9ff;}
canvas{border:1px solid #ccc;border-radius:10px;width:100%;max-width:300px;height:120px;touch-action:none;background:#fff;}
.clear-btn{background:#fff;color:#555;border:1px solid #ccc;padding:6px 10px;border-radius:8px;margin-top:4px;cursor:pointer;}
.clear-btn:hover{background:#eee;}
</style>
</head>

<body>
<div class="brandbar">
  <div class="brandbar-inner">
    <img src="img/logo_colegio.png" class="logo-colegio" alt="Logo Liceo">
    <div>
      <div><b>Red Crecemos</b></div>
      <div>Liceo Teniente Dagoberto Godoy Nº3</div>
    </div>
  </div>
</div>

<div class="wrap" id="formulario">
  <div class="card">
    <h1>CARTA DE POSTULACIÓN A ELECTIVIDADES 2025</h1>

    <p>Yo, <input id="apellido" placeholder="Apellidos">
      <input id="nombre" placeholder="Nombres">,
      RUT: <input id="rut_estudiante" placeholder="22.843.101-K" style="max-width:200px">,
      estudiante del curso 
      <select id="curso">
        <option></option><option>2° Medio A</option><option>2° Medio B</option><option>2° Medio C</option>
      </select>,
      declaro mi intención de electividad para el año 2026.
    </p>

    <p>En conocimiento de mi apoderado 
      <input id="apoderado" placeholder="Nombre del apoderado">
      RUT: <input id="rut_apoderado" placeholder="12.345.678-9" style="max-width:220px">,
      procedo a declarar mis elecciones de asignaturas.
    </p>

    <h2>Bloque 1</h2>
    <label>Geografía</label><select id="b1_op1" onchange="validarBloque('b1')"><option></option><option>1</option><option>2</option><option>3</option></select>
    <label>Democracia</label><select id="b1_op2" onchange="validarBloque('b1')"><option></option><option>1</option><option>2</option><option>3</option></select>
    <label>Estética</label><select id="b1_op3" onchange="validarBloque('b1')"><option></option><option>1</option><option>2</option><option>3</option></select>

    <h2>Bloque 2</h2>
    <label>Estadística</label><select id="b2_op1" onchange="validarBloque('b2')"><option></option><option>1</option><option>2</option><option>3</option></select>
    <label>Física</label><select id="b2_op2" onchange="validarBloque('b2')"><option></option><option>1</option><option>2</option><option>3</option></select>
    <label>Biología</label><select id="b2_op3" onchange="validarBloque('b2')"><option></option><option>1</option><option>2</option><option>3</option></select>

    <h2>Bloque 3</h2>
    <label>Música</label><select id="b3_op1" onchange="validarBloque('b3')"><option></option><option>1</option><option>2</option><option>3</option></select>
    <label>Artes</label><select id="b3_op2" onchange="validarBloque('b3')"><option></option><option>1</option><option>2</option><option>3</option></select>
    <label>Economía</label><select id="b3_op3" onchange="validarBloque('b3')"><option></option><option>1</option><option>2</option><option>3</option></select>

    <div class="firmas">
      <div>
        <p><b>Firma Estudiante</b></p>
        <canvas id="firma_estudiante"></canvas>
        <button class="clear-btn" onclick="limpiarFirma('firma_estudiante')">Limpiar</button>
      </div>
      <div>
        <p><b>Firma Apoderado</b></p>
        <canvas id="firma_apoderado"></canvas>
        <button class="clear-btn" onclick="limpiarFirma('firma_apoderado')">Limpiar</button>
      </div>
    </div>

    <button onclick="guardarYEnviar()">Enviar Postulación</button>
  </div>
</div>

<footer>© 2025 Red Crecemos — Liceo Teniente Dagoberto Godoy Nº3.</footer>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzphz-C2GRD-DDEEO0IlsqkzQM0F-Q80Z84AIZUg56snz4h3GpK2Gdq6DRBPuPKGoST5Q/exec"; // ← cambia esto

function validarBloque(b){
  const s=document.querySelectorAll(`[id^="${b}_op"]`);
  const usados=new Set();
  s.forEach(x=>{
    if(x.value&&usados.has(x.value)){alert("⚠️ No puedes repetir número.");x.value="";}
    else if(x.value)usados.add(x.value);
  });
}

function initFirma(id){
  const c=document.getElementById(id);c.width=c.offsetWidth;c.height=c.offsetHeight;
  const ctx=c.getContext("2d");let draw=false;
  const xy=e=>{const r=c.getBoundingClientRect();const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;return{x,y}};
  const start=e=>{draw=true;const {x,y}=xy(e);ctx.beginPath();ctx.moveTo(x,y);}
  const stop=()=>{draw=false;ctx.beginPath();}
  const move=e=>{if(!draw)return;e.preventDefault();const {x,y}=xy(e);ctx.lineWidth=2;ctx.lineCap="round";ctx.strokeStyle="#000";ctx.lineTo(x,y);ctx.stroke();ctx.beginPath();ctx.moveTo(x,y);}
  c.addEventListener("mousedown",start);c.addEventListener("mouseup",stop);c.addEventListener("mousemove",move);
  c.addEventListener("touchstart",start,{passive:false});c.addEventListener("touchend",stop,{passive:false});c.addEventListener("touchmove",move,{passive:false});
}
function limpiarFirma(id){const c=document.getElementById(id);c.getContext("2d").clearRect(0,0,c.width,c.height);}
window.onload=()=>{initFirma("firma_estudiante");initFirma("firma_apoderado");};

async function guardarYEnviar(){
  const apellido=document.getElementById("apellido").value.trim();
  const nombre=document.getElementById("nombre").value.trim();
  const rut=document.getElementById("rut_estudiante").value.trim();
  const curso=document.getElementById("curso").value.trim();
  const apoderado=document.getElementById("apoderado").value.trim();
  const rutApo=document.getElementById("rut_apoderado").value.trim();

  if(!apellido||!nombre||!rut||!curso||!apoderado||!rutApo)
    return alert("Completa todos los datos.");

  const form=document.getElementById("formulario");
  const canvas=await html2canvas(form,{scale:2,useCORS:true});
  const imgData=canvas.toDataURL("image/png");

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p","pt","a4");
  const w = pdf.internal.pageSize.getWidth();
  const h = (canvas.height * w) / canvas.width;
  pdf.addImage(imgData, "PNG", 0, 0, w, h);
  const pdfBase64 = pdf.output("datauristring");

  const p=new FormData();
  p.append("nombre",`${apellido.toUpperCase()} ${nombre}`);
  p.append("rutEstudiante",rut);
  p.append("curso",curso);
  p.append("apoderado",apoderado);
  p.append("rutApoderado",rutApo);
  p.append("b1_op1",b1_op1.value);p.append("b1_op2",b1_op2.value);p.append("b1_op3",b1_op3.value);
  p.append("b2_op1",b2_op1.value);p.append("b2_op2",b2_op2.value);p.append("b2_op3",b2_op3.value);
  p.append("b3_op1",b3_op1.value);p.append("b3_op2",b3_op2.value);p.append("b3_op3",b3_op3.value);
  p.append("documento",pdfBase64);

  try{
    const res=await fetch(SCRIPT_URL,{method:"POST",body:p});
    const txt=await res.text();
    alert(txt);
    window.print();
  }catch(e){
    console.error(e);
    alert("❌ Error al guardar o conectar con el servidor: "+e.message);
  }
}
</script>
</body>
</html>
