<!DOCTYPE html>
<html lang="es-CL">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#f58b1f">
<title>Carta de Postulación a Electividades 2025 · Liceo Teniente Dagoberto Godoy Nº3</title>

<!-- Fuentes y librerías -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --brand:#0b5db6;--brand-strong:#0a4f9d;--orange:#f58b1f;
  --bg:#f4f7fb;--card:#fff;--ink:#1f2937;--muted:#555;
  --border:#e7eefb;--radius:18px;--shadow-sm:0 8px 18px rgba(10,79,157,.10);
}
body{
  margin:0;
  font-family:"Montserrat",sans-serif;
  color:var(--ink);
  background:var(--bg);
  display:grid;
  grid-template-rows:auto 1fr auto;
  min-height:100dvh;
  overflow-x:hidden;
  font-size: 13px;
}
.brandbar{
  background:linear-gradient(90deg,#f58b1f,#f3a24a 30%,#4783cf 75%,#0b5db6 100%);
  color:#fff;
  padding: 6px 0;
}
.brandbar-inner{
  max-width:980px;
  margin:0 auto;
  padding:6px 16px;
  display:flex;
  align-items:center;
  gap:10px;
}
.logo-colegio{
  height:60px;
  width:auto;
  object-fit:contain;
}
.wrap{
  max-width:980px;
  margin:15px auto;
  padding:0 16px;
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:18px;
  box-shadow:var(--shadow-sm);
}
h1{
  font-size:1.3rem;
  margin:0 0 12px;
  font-weight:700;
  color:var(--brand-strong);
  text-align:center;
}
h2{
  margin-top:18px;
  color:var(--brand-strong);
  font-size:1.1rem;
}
label{
  font-weight:600;
  display:block;
  margin-bottom:4px;
}
input,select{
  width:100%;
  padding:8px 10px;
  border:1px solid #dce6f7;
  border-radius:8px;
  margin:2px 0 10px;
  font-size:13px;
  box-sizing:border-box;
}
button{
  background:var(--orange);
  color:#fff;
  font-weight:700;
  border:none;
  border-radius:10px;
  padding:10px 18px;
  cursor:pointer;
  display:block;
  margin:20px auto 0;
  box-shadow:0 6px 14px rgba(245,139,31,.25);
  transition:.2s;
  font-size:13px;
}
button:hover{
  background:#e57e12;
}
footer{
  text-align:center;
  font-size:.8rem;
  color:var(--muted);
  padding:10px;
  border-top:1px solid #e9eef9;
  background:#f6f9ff;
}
canvas{
  border:1px solid #ccc;
  border-radius:8px;
  width:100%;
  max-width:300px;
  height:100px;
  touch-action:none;
  background:#fff;
}
.clear-btn{
  background:#fff;
  color:#555;
  border:1px solid #ccc;
  padding:4px 8px;
  border-radius:6px;
  margin-top:4px;
  cursor:pointer;
  font-size:11px;
}
.clear-btn:hover{
  background:#eee;
}

/* Estilos para impresión optimizados */
@media print{
  .brandbar,.clear-btn,button,footer{
    display:none !important;
  }
  .card{
    box-shadow:none;
    border:none;
    margin:0;
    padding:8px;
    background:white;
  }
  body{
    background:white;
    font-size:12px;
  }
  h1{
    font-size:1.2rem;
    margin-bottom:6px;
  }
  @page{
    size:A4;
    margin:0.7cm;
  }
}

/* Layout optimizado para los bloques */
.bloque-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  margin: 15px 0;
}

.bloque-item {
  background: #f8fafd;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #e1e8f7;
}

.bloque-item h3 {
  margin: 0 0 10px 0;
  font-size: 1rem;
  color: var(--brand-strong);
  text-align: center;
  background: var(--brand);
  color: white;
  padding: 6px;
  border-radius: 6px;
}

.opcion-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 1px dashed #e1e8f7;
}

.opcion-item:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

.opcion-item label {
  flex: 1;
  margin: 0;
  font-weight: 500;
  font-size: 12px;
}

.opcion-item select {
  width: 70px;
  margin: 0;
  padding: 6px;
}

.firmas-container {
  display: flex;
  justify-content: space-around;
  flex-wrap: wrap;
  margin-top: 15px;
  gap: 15px;
  padding: 15px;
  background: #f8fafd;
  border-radius: 10px;
  border: 1px solid #e1e8f7;
}

.firma-box {
  text-align: center;
  flex: 1;
  min-width: 150px;
}

.firma-box b {
  font-size: 12px;
  display: block;
  margin-bottom: 6px;
}

.declaracion {
  background: #fff8e1;
  padding: 15px;
  border-radius: 10px;
  border: 1px solid #ffeaa7;
  margin: 20px 0;
  font-size: 0.9rem;
  line-height: 1.4;
}

.instruccion-bloques {
  background: #e8f4ff;
  padding: 12px;
  border-radius: 8px;
  margin: 15px 0;
  font-size: 0.9rem;
  text-align: center;
  border: 1px solid #cce0ff;
}

/* Estilos para el selector de curso */
.curso-selector {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin: 0 5px;
}

.curso-selector select {
  width: auto;
  min-width: 100px;
  margin: 0;
}
</style>
</head>

<body>
<!-- Encabezado -->
<div class="brandbar">
  <div class="brandbar-inner">
    <img src="img/logo_colegio.png" class="logo-colegio" alt="Logo Liceo">
    <div>
      <div><b>Red Crecemos</b></div>
      <div>Liceo Teniente Dagoberto Godoy Nº3</div>
    </div>
  </div>
</div>

<!-- Formulario -->
<div class="wrap" id="formulario">
  <div class="card">
    <h1>CARTA DE POSTULACIÓN A ELECTIVIDADES 2025</h1>
    <p><b>Selección de electivos de formación diferenciada Humanista-Científico 2025</b></p>

    <p>Yo, 
      <input id="apellido" placeholder="Primer apellido, Segundo apellido"> 
      <input id="nombre" placeholder="Primer nombre, Segundo nombre">,
      RUT: <input id="rut_estudiante" placeholder="12.345.678-9" style="max-width:200px;">,
      estudiante del curso 
      <span class="curso-selector">
        <select id="curso">
          <option value="2°M A 2025">2°M A 2025</option>
          <option value="2°M B 2025">2°M B 2025</option>
          <option value="2°M C 2025">2°M C 2025</option>
        </select>
      </span>
      , declaro por medio de este documento, mi intención de electividad para el año 2026 en el establecimiento Liceo Teniente Dagoberto Godoy N°3 Lo Prado.
    </p>

    <p>En conocimiento de mi apoderado 
      <input id="apoderado" placeholder="Primer apellido, Segundo apellido, Primer nombre, Segundo nombre">
      RUT: <input id="rut_apoderado" placeholder="12.345.678-9" style="max-width:220px;">, procedo a declarar mi elección para las siguientes asignaturas electivas:
    </p>

    <div class="instruccion-bloques">
      <b>Para esto debo numerar los tres bloques, en donde el 1 será su primera elección y el número 3 será el electivo de menor preferencia.</b>
    </div>

    <div class="bloque-grid">
      <div class="bloque-item">
        <h3>BLOQUE 1</h3>
        <div style="text-align: center; margin-bottom: 10px; font-size: 11px; color: #666;">
          <b>1-Primera preferencia | 2-Segunda preferencia | 3-Tercera preferencia</b>
        </div>
        <div class="opcion-item">
          <label>Geografía, Territorio y Desafíos Socioambientales</label>
          <select id="b1_op1" onchange="validarBloque('b1')">
            <option></option><option>1</option><option>2</option><option>3</option>
          </select>
        </div>
        <div class="opcion-item">
          <label>Participación y Argumentación en Democracia</label>
          <select id="b1_op2" onchange="validarBloque('b1')">
            <option></option><option>1</option><option>2</option><option>3</option>
          </select>
        </div>
        <div class="opcion-item">
          <label>Estética</label>
          <select id="b1_op3" onchange="validarBloque('b1')">
            <option></option><option>1</option><option>2</option><option>3</option>
          </select>
        </div>
      </div>

      <div class="bloque-item">
        <h3>BLOQUE 2</h3>
        <div style="text-align: center; margin-bottom: 10px; font-size: 11px; color: #666;">
          <b>1-Primera preferencia | 2-Segunda preferencia | 3-Tercera preferencia</b>
        </div>
        <div class="opcion-item">
          <label>Probabilidades y Estadísticas Descriptivas e Inferencial</label>
          <select id="b2_op1" onchange="validarBloque('b2')">
            <option></option><option>1</option><option>2</option><option>3</option>
          </select>
        </div>
        <div class="opcion-item">
          <label>Física</label>
          <select id="b2_op2" onchange="validarBloque('b2')">
            <option></option><option>1</option><option>2</option><option>3</option>
          </select>
        </div>
        <div class="opcion-item">
          <label>Biología de los Ecosistemas</label>
          <select id="b2_op3" onchange="validarBloque('b2')">
            <option></option><option>1</option><option>2</option><option>3</option>
          </select>
        </div>
      </div>

      <div class="bloque-item">
        <h3>BLOQUE 3</h3>
        <div style="text-align: center; margin-bottom: 10px; font-size: 11px; color: #666;">
          <b>1-Primera preferencia | 2-Segunda preferencia | 3-Tercera preferencia</b>
        </div>
        <div class="opcion-item">
          <label>Creación y Composición Musical</label>
          <select id="b3_op1" onchange="validarBloque('b3')">
            <option></option><option>1</option><option>2</option><option>3</option>
          </select>
        </div>
        <div class="opcion-item">
          <label>Artes Visuales y Audiovisuales</label>
          <select id="b3_op2" onchange="validarBloque('b3')">
            <option></option><option>1</option><option>2</option><option>3</option>
          </select>
        </div>
        <div class="opcion-item">
          <label>Economía y Sociedad</label>
          <select id="b3_op3" onchange="validarBloque('b3')">
            <option></option><option>1</option><option>2</option><option>3</option>
          </select>
        </div>
      </div>
    </div>

    <div class="declaracion">
      <p><b>Declaro que esta postulación será enviada digitalmente antes del 07 de noviembre a las 15:30 hrs.</b></p>
      <p><b>Acepto que, en caso de no enviar este formulario a tiempo, seré asignado a los electivos disponibles según demanda.</b></p>
    </div>

    <div class="firmas-container">
      <div class="firma-box">
        <b>Firma Estudiante</b>
        <canvas id="firma_estudiante"></canvas>
        <button class="clear-btn" onclick="limpiarFirma('firma_estudiante')">Limpiar</button>
        <div style="margin-top: 5px; font-size: 11px;">RUT: <span id="rut_estudiante_display"></span></div>
      </div>
      <div class="firma-box">
        <b>Firma Apoderado</b>
        <canvas id="firma_apoderado"></canvas>
        <button class="clear-btn" onclick="limpiarFirma('firma_apoderado')">Limpiar</button>
        <div style="margin-top: 5px; font-size: 11px;">RUT: <span id="rut_apoderado_display"></span></div>
      </div>
    </div>

    <button onclick="guardarYEnviar()">Enviar Postulación</button>
  </div>
</div>

<footer>© 2025 Red Crecemos — Liceo Teniente Dagoberto Godoy Nº3.</footer>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzzwbEiIRQaLjEtgFHjeCee6IYzcuppTSTrgEZ4pGh8mo0AExawIby2qdW9MMF33r-zOA/exec";

function validarBloque(b){
  const selects = document.querySelectorAll(`[id^="${b}_op"]`);
  const usados = new Set();
  let hasError = false;
  
  selects.forEach(sel => {
    if(sel.value && usados.has(sel.value)){
      alert("⚠️ No puedes repetir el mismo número dentro del mismo bloque.");
      sel.value = "";
      hasError = true;
    } else if(sel.value){
      usados.add(sel.value);
    }
  });
  return !hasError;
}

function initFirma(id){
  const c = document.getElementById(id);
  c.width = c.offsetWidth;
  c.height = c.offsetHeight;
  const ctx = c.getContext("2d");
  let d = false;
  
  const get = e => {
    const r = c.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
    return {x, y};
  };
  
  const start = e => { d = true; const {x, y} = get(e); ctx.beginPath(); ctx.moveTo(x, y); }
  const stop = () => { d = false; ctx.beginPath(); }
  const move = e => { 
    if(!d) return; 
    e.preventDefault(); 
    const {x, y} = get(e); 
    ctx.lineWidth = 2; 
    ctx.lineCap = "round"; 
    ctx.strokeStyle = "#000"; 
    ctx.lineTo(x, y); 
    ctx.stroke(); 
    ctx.beginPath(); 
    ctx.moveTo(x, y); 
  }
  
  c.addEventListener("mousedown", start);
  c.addEventListener("mouseup", stop);
  c.addEventListener("mousemove", move);
  c.addEventListener("touchstart", start, {passive: false});
  c.addEventListener("touchend", stop, {passive: false});
  c.addEventListener("touchmove", move, {passive: false});
}

function limpiarFirma(id){
  const c = document.getElementById(id);
  c.getContext("2d").clearRect(0, 0, c.width, c.height);
}

// Actualizar RUT en tiempo real
document.getElementById('rut_estudiante').addEventListener('input', function(e) {
  document.getElementById('rut_estudiante_display').textContent = e.target.value;
});

document.getElementById('rut_apoderado').addEventListener('input', function(e) {
  document.getElementById('rut_apoderado_display').textContent = e.target.value;
});

// ✅ FUNCIÓN OPTIMIZADA - MÁS RÁPIDA Y CON MEJOR MANEJO DE ERRORES
async function guardarYEnviar(){
  const btn = event.target;
  const originalText = btn.textContent;
  
  try{
    // Mostrar indicador de carga
    btn.textContent = "⏳ Generando PDF...";
    btn.disabled = true;

    const apellido = document.getElementById("apellido").value.trim();
    const nombre = document.getElementById("nombre").value.trim();
    const rut = document.getElementById("rut_estudiante").value.trim();
    const curso = document.getElementById("curso").value;
    const apoderado = document.getElementById("apoderado").value.trim();
    const rutApo = document.getElementById("rut_apoderado").value.trim();

    if(!apellido || !nombre || !rut || !apoderado || !rutApo) {
      alert("⚠️ Completa todos los datos.");
      btn.textContent = originalText;
      btn.disabled = false;
      return;
    }

    // Validar bloques
    if (!validarBloque('b1') || !validarBloque('b2') || !validarBloque('b3')) {
      btn.textContent = originalText;
      btn.disabled = false;
      return;
    }

    const form = document.getElementById("formulario");
    
    btn.textContent = "⏳ Capturando pantalla...";
    
    // CONFIGURACIÓN OPTIMIZADA - MÁS RÁPIDA
    const canvas = await html2canvas(form, {
      scale: 1.5, // Reducido de 2 a 1.5 para mejor performance
      useCORS: true,
      logging: false,
      backgroundColor: '#ffffff',
      removeContainer: true,
      width: form.scrollWidth,
      height: form.scrollHeight,
      onclone: function(clonedDoc) {
        // Ocultar botones durante la captura para mejor apariencia
        const buttons = clonedDoc.querySelectorAll('button, .clear-btn');
        buttons.forEach(btn => btn.style.display = 'none');
      }
    });
    
    btn.textContent = "⏳ Creando PDF...";
    
    // Usar JPEG para reducir tamaño (80% calidad - buen balance)
    const imgData = canvas.toDataURL("image/jpeg", 0.8);

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "mm", "a4");
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    // Calcular dimensiones con márgenes
    const imgWidth = pageWidth - 20; // Margen de 10mm cada lado
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    let position = 0;
    let heightLeft = imgHeight;

    // Añadir primera página
    pdf.addImage(imgData, "JPEG", 10, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    // Añadir páginas adicionales si es necesario
    while(heightLeft > 0){
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, "JPEG", 10, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }

    const pdfBase64 = pdf.output("datauristring");

    // Preparar datos del formulario
    const data = new FormData();
    data.append("nombre", `${apellido.toUpperCase()} ${nombre}`);
    data.append("rutEstudiante", rut);
    data.append("curso", curso);
    data.append("apoderado", apoderado);
    data.append("rutApoderado", rutApo);
    data.append("b1_op1", document.getElementById('b1_op1').value);
    data.append("b1_op2", document.getElementById('b1_op2').value);
    data.append("b1_op3", document.getElementById('b1_op3').value);
    data.append("b2_op1", document.getElementById('b2_op1').value);
    data.append("b2_op2", document.getElementById('b2_op2').value);
    data.append("b2_op3", document.getElementById('b2_op3').value);
    data.append("b3_op1", document.getElementById('b3_op1').value);
    data.append("b3_op2", document.getElementById('b3_op2').value);
    data.append("b3_op3", document.getElementById('b3_op3').value);
    data.append("documento", pdfBase64);

    // Enviar con timeout más realista
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 25000); // 25 segundos

    btn.textContent = "⏳ Enviando...";
    
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: data,
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    if (!res.ok) {
      throw new Error(`Error del servidor: ${res.status}`);
    }
    
    const txt = await res.text();

    if(txt.startsWith("http")) {
      alert("✅ Postulación enviada correctamente.");
      window.print();
    } else {
      alert("❌ Error: " + txt);
    }

  } catch(e) {
    if(e.name === 'AbortError') {
      alert("❌ Tiempo de espera agotado. El servidor está tardando demasiado. Intenta nuevamente.");
    } else {
      alert("❌ Error: " + e.message);
      console.error("Error detallado:", e);
    }
  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
}

window.onload = () => {
  initFirma("firma_estudiante");
  initFirma("firma_apoderado");
};
</script>
</body>
</html>